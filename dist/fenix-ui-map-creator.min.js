define(["jquery","loglevel","underscore","fenix-ui-map","fenix-ui-pivotator","fenix-ui-pivotator-utils","amplify-pubsub"],function(e,t,i,a,n,o,r){return function(e){function t(a){if(i[a])return i[a].exports;var n=i[a]={exports:{},id:a,loaded:!1};return e[a].call(n.exports,n,n.exports,t),n.loaded=!0,n.exports}var i={};return t.m=e,t.c=i,t.p="",t(0)}([function(e,t,i){e.exports=i(1)},function(e,t,i){var a,n;a=[i(3),i(7),i(4),i(5),i(6),i(2),i(8),i(9),i(10),i(11)],n=function(e,t,i,a,n,o,r,s,l,u){"use strict";function d(e){i.info("FENIX MapCreator"),i.info(e),t.extend(this,o,{initial:e}),this._parseInput(e),this.fenix_ui_mapConfig=e.fenix_ui_map;var a=this._validateInput();return a===!0?(this._initVariables(),this._bindEventListeners(),this._renderMap(),this):(i.error("Impossible to create MapCreator"),void i.error(a))}return d.prototype.on=function(e,t,i){var a=i||this;return this.channels[e]||(this.channels[e]=[]),this.channels[e].push({context:a,callback:t}),this},d.prototype.addBaseLayer=function(e){return this.fenixMap.addTileLayer(e,!0),this},d.prototype.addLayer=function(e){var t;return!!e&&(e instanceof L.TileLayer?this.fenixMap.map.addLayer(e):(!this.errors||e&&e.hasOwnProperty("metadata")||(this.errors.metadata="Model does not contain 'metadata' attribute."),t="string"==typeof e?this.createLayerFenixUid(e):e.hasOwnProperty("data")?this.createLayerFenixJoin(e):this.createLayerFenix(e),t=new r.layer(t),"object"==typeof e&&e.metadata&&e.metadata.title&&e.metadata.title.EN&&(t.layer.layertitle=e.metadata.title.EN),this.initial.legendtitle&&(t.layer.layertitle=this.initial.legendtitle),this.fenixMap.addLayer(t),t))},d.prototype.removeLayer=function(e){if(this.status.ready===!0)return this},d.prototype.invalidateSize=function(){if(this.status.ready===!0)return this.fenixMap.invalidateSize(),this},d.prototype._parseInput=function(){this.id=this.initial.id,this.$el=e(this.initial.el),this.model=this.initial.model;var t={};t.aggregationFn=this.initial.aggregationFn,t.aggregations=this.initial.aggregations||[],t.hidden=this.initial.hidden||[],t.columns=this.initial.x,t.values=this.initial.y||["value"],t.rows=this.initial.series,t.formatter=this.initial.formatter||"value",t.valueOutputType=this.initial.valueOutputType,t.showRowHeaders=this.initial.showRowHeaders||!1,t.decimals=this.initial.decimals||2,t.showCode=this.initial.showCode||!1,t.showFlag=this.initial.showFlag||!1,t.showUnit=this.initial.showUnit||!1,this.pivotatorConfig=t},d.prototype._validateInput=function(){var e=!0,t=[];return this.id||(window.fx_map_id>=0?window.fx_map_id++:window.fx_map_id=0,this.id=String(window.fx_map_id),i.warn("Impossible to find MapCreator id. Set auto id to: "+this.id)),0===this.$el.length&&(t.push({code:a.MISSING_CONTAINER}),i.warn("Impossible to find box container")),t.length>0?t:e},d.prototype._initVariables=function(){this.channels={},this.status={},this.status.ready=!1,this.pivotator=new s,this.fenixTool=new l},d.prototype._bindEventListeners=function(){u.subscribe(this._getEventName(n.WINDOW_RESIZE),this,this.invalidateSize)},d.prototype._renderMap=function(){var e=this;e.fenixMap=new r.Map(e.$el,e.fenix_ui_mapConfig),e.fenixMap.createMap(),e.leafletMap=e.fenixMap.map,e.model?e.addLayer(e.model):this.initial.uid&&e.addLayer(this.initial.uid),e.status.ready=!0,setTimeout(t.bind(function(){e._trigger("ready")},e),0)},d.prototype._trigger=function(e){if(!this.channels[e])return!1;for(var t=Array.prototype.slice.call(arguments,1),i=0,a=this.channels[e].length;i<a;i++){var n=this.channels[e][i];n.callback.apply(n.context,t)}return this},d.prototype._getEventName=function(e){return this.id.concat(e)},d.prototype._unbindEventListeners=function(){u.unsubscribe(this._getEventName(n.WINDOW_RESIZE),this.invalidateSize)},d.prototype.dispose=function(){this._unbindEventListeners(),this.status.ready===!0&&this.fenixMap.destroyMap(),this.$el.empty()},d.prototype.createLayerFenix=function(e,t){var i=e.metadata,a={};if(!i.hasOwnProperty("dsd"))throw this.errors.dsd="Model['metadata'] does not contain 'dsd' attribute.",new Error("FENIX Map creator has not a valid configuration");return a.layers="",i.dsd.hasOwnProperty("workspace")&&(a.layers+=i.dsd.workspace+":"),a.layers+=i.dsd.layerName,a.urlWMS=this.fenix_ui_map.DEFAULT_WMS_SERVER,a.layertitle={en:"Data Layer"},a.opacity="0.9",a},d.prototype.createLayerFenixUid=function(e){var t={urlWMS:this.DEFAULT_WMS_SERVER,layertitle:{en:"Data Layer"},opacity:"0.9",layers:e};return t},d.prototype.createLayerFenixJoin=function(e){if(this._validateJoinInput(e)===!0){var i=this.getJoinLayer(e);t.extend(i,this.join.style);var a="<div class='fm-popup'>{{"+i.joincolumnlabel+"}}<div class='fm-popup-join-content'>{{{"+i.joincolumn+"}}} {{measurementunit}}</div></div>";e.metadata.hasOwnProperty("title")?e.metadata.title[this.lang]&&(i.layertitle=e.metadata.title[this.lang]):i.layertitle=e.metadata.uid,this.hasOwnProperty("layer")&&this.layer.hasOwnProperty("layertitle")&&(i.layertitle=this.layer.layertitle),this.hasOwnProperty("layer")&&this.layer.hasOwnProperty("popupBuilder")&&(i.popupBuilder=this.layer.popupBuilder),i.customgfi={showpopup:!0,content:{EN:t.isFunction(i.popupBuilder)?i.popupBuilder(i.joincolumnlabel,i.joincolumn):a}};var n=[];i.joindata.forEach(function(e){t.keys(e).forEach(function(e){t.isNumber(parseInt(e))&&n.push(e)})});var o=i.layers.split(":");return o=o.length>1?o[1]:o[0],this.fenixMap.zoomTo(o,i.joincolumn,n),this.initial.colorRamp&&(i.colorramp=this.initial.colorRamp),i}},d.prototype.getJoinLayer=function(e){var i=e.metadata,a={},n={},o={};if(i.dsd.columns.forEach(t.bind(function(e,t){e.subject!==this.geoSubject&&e.id!==this.geoSubject||(a=e,a.index=t),e.subject!==this.valueSubject&&e.id!==this.valueSubject||(n=e,n.index=t),e.subject===this.muSubject&&(o=e,o.index=t)},this)),i.dsd.columns.forEach(t.bind(function(e,t){o.id+"_"+this.lang&&(o=e,o.index=t)},this)),this._validateJoinColumnInput(a)){var r=null,s=a.domain.codes[0].idCodeList.toLowerCase();if(this.join.layerMapping[s])r=this.join.layerMapping[s];else{a.domain.codes[0].idCodeList.toLowerCase();var l=i.meContent.seReferencePopulation.referenceArea.codes[0].code.toLowerCase();r=this.join.layerMapping[s+"_"+l]}return r.joindata=this.getJoinData(e.data,a.index,n.index),r.measurementunit=e.data[0][o.index],r.legendtitle=r.measurementunit,r.layertitle="OCD",r}console.error("Error JoinColumnInput not valid")},d.prototype.getJoinData=function(e,i,a){var n=[],o={};return e.forEach(t.bind(function(e){var t={},r=e[i],s=e[a];r&&s&&(t[r]=s,o.hasOwnProperty(r)||(o[r]=!0,n.push(t)))},this)),n},d.prototype._validateJoinInput=function(e){return this.errors={},e.hasOwnProperty("metadata")||(this.errors.metadata="'metadata' attribute not present."),e.hasOwnProperty("data")||(this.errors.data="'data' attribute not present."),0===t.keys(this.errors).length},d.prototype._validateJoinColumnInput=function(e){return this.errors={},e.hasOwnProperty("key")?e.key!==!0&&(this.errors.column="'key' is not true."):this.errors.column="'key' attribute not present.",e.hasOwnProperty("dataType")?"code"!==e.dataType&&(this.errors.column="'dataType' attribute is not a coding system."):this.errors.column="'dataType' attribute not present.",0===Object.keys(this.errors).length},d}.apply(t,a),!(void 0!==n&&(e.exports=n))},function(e,t,i){var a;a=function(){"use strict";return{WMS_URL:"http://fenix.fao.org/demo/fenix/geoserver",DEFAULT_WMS_SERVER:"http://fenix.fao.org/demo/fenix/geoserver",url:{wms:"http://fenix.fao.org/demo/fenix/geoserver"},fenix_ui_map:{plugins:{disclaimerfao:!0,geosearch:!0,mouseposition:!1,controlloading:!0,zoomcontrol:"bottomright"},guiController:{overlay:!1,baselayer:!0,wmsLoader:!1},gui:{disclaimerfao:!0}},leaflet:{zoomControl:!1,attributionControl:!1,minZoom:1},layers:{gaul0:{layers:"fenix:gaul0_3857",urlWMS:"http://fenix.fao.org/demo/fenix/geoserver",opacity:"0.9",joincolumn:"adm0_code",joincolumnlabel:"areanamee",layertype:"JOIN",jointype:"shaded",openlegend:!0,defaultgfi:!0,colorramp:"YlGn",lang:"en"}},geoSubject:"geo",colorRamp:"Reds",valueSubject:"value",muSubject:null,join:{style:{layertype:"JOIN",jointype:"shaded",defaultgfi:!0,openlegend:!0,lang:"EN",opacity:"0.7",colorramp:"Greens",decimalvalues:2},layerMapping:{escap_area:{layers:"fenix:gaul0_3857",joincolumn:"adm0_code",joincolumnlabel:"adm0_name"},gaul0:{layers:"fenix:gaul0_3857",joincolumn:"adm0_code",joincolumnlabel:"adm0_name"},gaul1:{layers:"fenix:gaul1_3857",joincolumn:"adm1_code",joincolumnlabel:"adm1_name"},uae_gaul:{layers:"fenix:gaul1_3857",joincolumn:"adm1_code",joincolumnlabel:"adm1_name"},gaul_adm1:{layers:"fenix:gaul1_3857",joincolumn:"adm1_code",joincolumnlabel:"adm1_name"},faostat_countrycodes:{layers:"fenix:gaul0_faostat_3857",joincolumn:"faost_code",joincolumnlabel:"areanamee"},faostat_countries:{layers:"fenix:gaul0_faostat_3857",joincolumn:"faost_code",joincolumnlabel:"areanamee"},gaul:{layers:"fenix:gaul1_3857",joincolumn:"adm1_code",joincolumnlabel:"adm1_name"},uneca_partner:{layers:"fenix:gaul0_faostat3_3857",joincolumn:"iso3",joincolumnlabel:"areanamee"},gaul1_afg:{layers:"fenix:gaul1_3857",joincolumn:"adm1_code",joincolumnlabel:"adm1_name"},iso3:{layers:"fenix:gaul0_faostat3_3857",joincolumn:"iso3",joincolumnlabel:"areanamee"},uneca_iso3:{layers:"fenix:gaul0_faostat3_3857",joincolumn:"iso3",joincolumnlabel:"areanamee"}}}}}.call(t,i,t,e),!(void 0!==a&&(e.exports=a))},function(t,i){t.exports=e},function(e,i){e.exports=t},function(e,t,i){var a;a=function(){"use strict";return{MISSING_CONTAINER:"missing_container"}}.call(t,i,t,e),!(void 0!==a&&(e.exports=a))},function(e,t,i){var a;a=function(){"use strict";return{WINDOW_RESIZE:"fs.window.resize.event"}}.call(t,i,t,e),!(void 0!==a&&(e.exports=a))},function(e,t){e.exports=i},function(e,t){e.exports=a},function(e,t){e.exports=n},function(e,t){e.exports=o},function(e,t){e.exports=r}])});
//# sourceMappingURL=fenix-ui-map-creator.min.js.map